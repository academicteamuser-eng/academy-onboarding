<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academy: Онбординг внештатных авторов</title>
    <style>
        /* ОБЪЯВЛЕНИЕ ПОЛЬЗОВАТЕЛЬСКИХ ШРИФТОВ */
        @font-face {
            font-family: 'CustomHeadingFont';
            src: url('https://academicteamuser-eng.github.io/academy-onboarding/fonts/SBSansDisplay-Bold.woff') format('woff');
            font-weight: 400 700;
            font-style: normal;
            font-display: swap;
        }
        
        @font-face {
            font-family: 'CustomBodyFont';
            src: url('https://academicteamuser-eng.github.io/academy-onboarding/fonts/SBSansText-Regular.woff') format('woff'),
            font-weight: 400 600;
            font-style: normal;
            font-display: swap;
        }

        :root {
            /* ЦВЕТОВАЯ ПАЛИТРА - можно легко менять */
            --primary-color: #2c3e50;
            --secondary-color: #272264;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
           /* --success-color: #FDB100;*/
            --success-color: #3ce792;
            --gradient-start: #005E7F;
            --gradient-end: #272264;
            
            /* ШРИФТЫ - используем ваши кастомные шрифты */
            --heading-font: 'CustomHeadingFont', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --body-font: 'CustomBodyFont', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            
            /* ДОПОЛНИТЕЛЬНЫЕ НАСТРОЙКИ */
            --border-radius: 8px;
            --box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
            font-family: var(--body-font);
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--heading-font);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            color: white;
            padding: 60px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative; 
}

.header-logo {
    height: 60px; /* Настройте под ваш логотип */
    width: auto;
}

.header-title {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    margin: 0;
    font-size: 32px;
    color: white;
    font-family: var(--heading-font);
}

.header-image {
    height: 180px;
    width: auto;
    position: absolute;
    right: 20px; /* Отступ справа */
    bottom: -60px; /* Отступ снизу - регулируйте по необходимости */
}
        
      /*  .logo {
            font-size: 24px;
            font-weight: bold;
            font-family: var(--heading-font);
        }*/
        
        .welcome-section {
            background-color: var(--light-color);
            padding: 60px 0;
            text-align: center;
        }
        
        .welcome-section h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-family: var(--heading-font);
        }
        
        .welcome-section p {
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
            font-family: var(--body-font);
        }
        
        .module {
            background-color: white;
            max-width: 800px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
          margin: 40px 0;
            transition: var(--transition);
            border-left: 4px solid var(--secondary-color);
        }

        .modules-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 20px;
}
        
        .module:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .module-title {
            font-size: 1.8rem;
            color: var(--primary-color);
            font-family: var(--heading-font);
        }
        
        .module-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            font-family: var(--body-font);
        }
        
        .status-not-started {
            background-color: #f1f1f1;
            color: #777;
        }
        
        .status-in-progress {
            background-color: #ffeaa7;
            color: #d35400;
        }
        
        .status-completed {
            background-color: var(--success-color);
            color: white;
        }
        
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
        }
        
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: var(--border-radius);
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            color: white;
            text-decoration: none;
            border-radius: var(--border-radius);
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-family: var(--body-font);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .btn-disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-disabled:hover {
            background: #ccc;
            transform: none;
            box-shadow: none;
        }
        
        .resources-section {
            background-color: var(--light-color);
            padding: 60px 0;
        }
        
        .resources-section h2 {
            text-align: center;
            margin-bottom: 40px;
            color: var(--primary-color);
            font-family: var(--heading-font);
        }
        
        .resources-list {
            list-style-type: none;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .resources-list li {
            margin-bottom: 15px;
        }
        
        .resources-list a {
            display: block;
            padding: 15px;
            background-color: white;
            border-radius: var(--border-radius);
            text-decoration: none;
            color: var(--dark-color);
            font-weight: 500;
            transition: var(--transition);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-family: var(--body-font);
            border-left: 3px solid var(--secondary-color);
        }
        
        .resources-list a:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            color: var(--secondary-color);
        }
        
        footer {
            background-color: var(--dark-color);
            color: white;
            padding: 30px 0;
            text-align: center;
            font-family: var(--body-font);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 100%;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal h2 {
            margin-bottom: 20px;
            color: var(--primary-color);
            font-family: var(--heading-font);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-family: var(--body-font);
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            font-family: var(--body-font);
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }
        
        .success-message {
            text-align: center;
            padding: 40px;
        }
        
        .success-message h2 {
            color: var(--success-color);
            margin-bottom: 20px;
            font-family: var(--heading-font);
        }
        
        .error-message {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 0.9rem;
            display: none;
        }
        
        .question {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .question-text {
            font-weight: 500;
            margin-bottom: 10px;
            font-family: var(--body-font);
        }

        .question-hint {
    color: #777;
    font-size: 0.9rem;
    margin-bottom: 10px;
    font-style: italic;
}
        .options label {
            display: block;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-family: var(--body-font);
        }
        
        .options label:hover {
            background-color: #f5f5f5;
        }
        
        .options input[type="radio"], 
        .options input[type="checkbox"] {
            margin-right: 10px;
        }
        
        .text-answer {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            margin-top: 5px;
            font-family: var(--body-font);
        }
        
        @media (max-width: 768px) {
            .header-title {
        font-size: 1.2rem;
    }
    
    .header-logo,
    .header-image {
        height: 30px;
    }
            .module-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .module-status {
                margin-top: 10px;
            }
            
            .welcome-section h1 {
                font-size: 2rem;
            }
            
            .module-title {
                font-size: 1.5rem;
            }
        }

        /* Результаты теста */
.correct-answer {
    background-color: #d4edda !important;
    border-left: 3px solid var(--success-color) !important;
}

.incorrect-answer {
    background-color: #f8d7da !important;
    border-left: 3px solid #e74c3c !important;
}

.user-choice {
    font-weight: bold;
}
        
    </style>
</head>
<body>
    <header>
    <div class="container header-content">
        <img src="https://academicteamuser-eng.github.io/academy-onboarding/img/logo" alt="Логотип" class="header-logo">
        <h1 class="header-title">Добро пожаловать</h1>
        <img src="https://academicteamuser-eng.github.io/academy-onboarding/img/img2" alt="картинка с экспертом" class="header-image">
    </div>
</header>
    
    <section class="welcome-section">
        <div class="container">
           <!-- <h1>Добро пожаловать в академию внештатных авторов!</h1> -->
            <p>Мы рады приветствовать вас в нашей команде! Это обучающая платформа поможет вам освоить ключевые принципы работы и качественно выполнять задачи. Пройдите все модули, чтобы стать частью нашей команды.</p>
        </div>
    </section>
    
    <div class="modules-container">
        <div class="module" id="module1">
            <div class="module-header">
                <h2 class="module-title">Модуль 1: ТоВ - как мы говорим<br>через текст</h2>
                <span class="module-status status-not-started" id="status1">Не начат</span>
            </div>
            <div class="video-container">
                <video controls id="video1">
                    <source src="https://academicteamuser-eng.github.io/academy-onboarding/20250606_0048_Flowing Lava Animation_simple_compose_01jx112fyaffctfjkrckk5m5f2.mp4" type="video/mp4">
                    Ваш браузер не поддерживает видео тег.
                </video>
            </div>
            <button class="btn btn-disabled" id="btn-module1" onclick="openTestModal(1)">Перейти к тесту</button>
        </div>
        
        <div class="module" id="module2">
            <div class="module-header">
                <h2 class="module-title">Модуль 2: Редактура</h2>
                <span class="module-status status-not-started" id="status2">Не начат</span>
            </div>
            <div class="video-container">
                <video controls poster="video-poster2.jpg" id="video2">
                    <source src="https://academicteamuser-eng.github.io/academy-onboarding/20250606_0149_Molten Metal Flow_simple_compose_01jx14h6ykfx9sx4amgczq4xxw.mp4" type="video/mp4">
                    Ваш браузер не поддерживает видео тег.
                </video>
            </div>
            <button class="btn btn-disabled" id="btn-module2" onclick="openTestModal(2)">Перейти к тесту</button>
        </div>
        
        <div class="module" id="module3">
            <div class="module-header">
                <h2 class="module-title">Модуль 3: Предметы</h2>
                <span class="module-status status-not-started" id="status3">Не начат</span>
            </div>
            <div class="video-container">
                <video controls poster="video-poster3.jpg" id="video3">
                    <source src="https://academicteamuser-eng.github.io/academy-onboarding/20250606_0122_Melting Metal Streams_simple_compose_01jx130xt1fbxtjx8d6ftgxacx.mp4" type="video/mp4">
                    Ваш браузер не поддерживает видео тег.
                </video>
            </div>
            <button class="btn btn-disabled" id="btn-module3" onclick="openTestModal(3)">Перейти к тесту</button>
        </div>
    </div>
    
    <section class="resources-section">
        <div class="container">
            <h2>Полезные ресурсы</h2>
            <ul class="resources-list">
                <li><a href="https://docs.google.com/document/d/12345" target="_blank">Гайд по стилю написания текстов</a></li>
                <li><a href="https://www.notion.so/example" target="_blank">База знаний Академблок</a></li>
                <li><a href="https://wiki.example.com/editing" target="_blank">Руководство по редактуре</a></li>
                <li><a href="https://docs.google.com/presentation/d/12345" target="_blank">Презентация основных принципов</a></li>
            </ul>
        </div>
    </section>
    
    <footer>
        <div class="container">
            <p>Академблок &copy; 2023. Все права защищены.</p>
        </div>
    </footer>
    
    <!-- Модальное окно для ввода данных -->
    <div class="modal" id="userDataModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('userDataModal')">&times;</span>
            <h2>Пожалуйста, представьтесь</h2>
            <p>Перед началом теста нам нужно знать, как к вам обращаться и как с вами связаться.</p>
            <form id="userDataForm">
                <div class="form-group">
                    <label for="userName">Имя и Фамилия*</label>
                    <input type="text" id="userName" required>
                </div>
                <div class="form-group">
                    <label for="userEmail">Электронная почта</label>
                    <input type="email" id="userEmail">
                </div>
                <div class="form-group">
                    <label for="userPhone">Номер для связи</label>
                    <input type="tel" id="userPhone">
                </div>
                <div id="formError" class="error-message"></div>
                <input type="hidden" id="currentModule">
                <button type="submit" class="btn">Начать тест</button>
            </form>
        </div>
    </div>
    
    <!-- Модальное окно с тестом -->
    <div class="modal" id="testModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('testModal')">&times;</span>
            <div id="testContent">
                <!-- Контент теста будет загружен здесь -->
            </div>
        </div>
    </div>
    
    <!-- Модальное окно с сообщением об успехе -->
    <div class="modal" id="successModal">
        <div class="modal-content success-message">
            <h2>Благодарим за прохождение обучения!</h2>
            <p>Мы вернемся с обратной связью в течение 3 дней.</p>
            <button class="btn" onclick="closeModal('successModal')">Закрыть</button>
        </div>
    </div>

    <!-- Подключаем Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Инициализация Supabase
        // ЗАМЕНИТЕ эти значения на свои из панели управления Supabase
        const SUPABASE_URL = 'https://ebrxicfaclqqgbjdwtoi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVicnhpY2ZhY2xxcWdiamR3dG9pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjM2OTIsImV4cCI6MjA3MjU5OTY5Mn0.dw2DsmhSqkKhIIV3G-iG5K3MhqnLvczXyxlwbd4nb_w';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Переменные для хранения данных пользователя и прогресса
        let userData = {
            name: '',
            email: '',
            phone: ''
        };
        
        let userId = null;
        let moduleProgress = {
            1: { started: false, completed: false, score: 0, videoWatched: false },
            2: { started: false, completed: false, score: 0, videoWatched: false },
            3: { started: false, completed: false, score: 0, videoWatched: false }
        };
        
        let startTime = null;
        let currentTestAnswers = {};
        
        // Определяем тесты
        const tests = {
            1: [
                {
                    id: 1,
                    question: "Какой принцип мы используем, чтобы учёба не создавала эмоциональный груз?",
                    type: "radio",
                    options: [
                        "Акцентируем внимание на высоких ожиданиях и результате",
                        "Используем шутки для снижения тревожности",
                        "Подсвечиваем ошибки для повышения мотивации",
                        "Используем подход «понимание важнее оценки»"
                    ],
                    correctAnswer: 3
                },
                {
                    id: 2,
                    question: "Почему мы избегаем устаревших мемов и сленга в коммуникации?",
                    type: "radio",
                    options: [
                        "Потому что это не соответствует формальным требованиям школ",
                        "Чтобы не панибратствовать и сохранять актуальность",
                        "Потому что это запрещено академическим директором",
                        "Чтобы упростить перевод контента на другие языки"
                    ],
                    correctAnswer: 1
                },
                {
                    id: 3,
                    question: "Какой из перечисленных элементов не входит в стиль общения бренда?",
                    type: "radio",
                    options: [
                        "Уважение",
                        "Безопасность",
                        "Забота",
                        "Юмор"
                    ],
                    correctAnswer: 1
                }
            ],
            2: [
                {
                    id: 1,
                    question: "Какой этап работы с текстом часто пропускают авторы, что приводит к проблемам на поздних стадиях?",
                    type: "radio",
                    options: [
                        "Финальная вычитка орфографии.",
                        "Уточняющие вопросы на этапе брифа.",
                        "Использование автоматических сервисов проверки.",
                        "Добавление визуализации в текст."
                    ],
                    correctAnswer: 1
                },
                {
                    id: 2,
                    question: "Что мы рекомендуем сделать при структурировании длинного текста?",
                    type: "checkbox",
                    options: [
                        "Разбить текст на абзацы по 3–5 строк.",
                        "Использовать подзаголовки и списки.",
                        "Объединить несколько вопросов в одном абзаце.",
                        "Написать несколько примеров для иллюстрации мыслей."
                    ],
                    correctAnswers: [0, 1] // Правильные ответы: первый и второй
                },
                {
                    id: 3,
                    question: "Какие инструменты вы будете использовать для проверки текста перед сдачей работы?",
                    type: "text",
                    correctAnswer: "" // Правильный ответ будет проверяться вручную
                }
            ],
            3: [
                {
                    id: 1,
                    question: "Какой принцип лежит в основе создания учебных материалов?",
                    type: "radio",
                    options: [
                        "Максимальное упрощение контента для быстрого усвоения",
                        "Получение готовых знаний с помощью учебников и лекций учителя",
                        "Обучение через действие и решение практических задач",
                        "Акцент на развлекательные элементы для вовлечения",
                        "Основной упор на запоминание фактов и воспроизведение изученного материала",
                        "Использование сложных терминов для академичности",
                        "Создание материалов исключительно для автоматизированной проверки",
                        "Работа в группах и обсуждение учениками изучаемых тем между собой"
                    ],
                    correctAnswer: 2
                },
                {
                    id: 2,
                    question: "Вы создаёте задание по физике про давление и хотите добавить иллюстрацию. Какой принцип будет определяющим при её выборе?",
                    type: "radio",
                    options: [
                        "Иллюстрация должна точно соответствовать научным данным и быть методически выверенной",
                        "Иллюстрация должна упрощать восприятие материала и быть полезной для понимания темы",
                        "Картинка должна соответствовать возрастным особенностям и интересам учеников",
                        "Изображение должно наглядно демонстрировать все формулы и расчёты по теме",
                        "Иллюстрация должна содержать подробные подписи и пояснения к каждому элементу",
                        "Иллюстрация должна показывать практическое применение физических законов в жизни"
                    ],
                    correctAnswer: 1
                },
                {
                    id: 3,
                    question: "Ваш коллега использует нейросеть для создания задания по литературе и просто копирует результат без изменений. Почему это проблема?",
                    type: "text",
                    correctAnswer: "" // Правильный ответ будет проверяться вручную
                }
            ]
        };
        
        // Функции для работы с модальными окнами
        function openTestModal(moduleId) {
            // Проверяем, просмотрено ли видео
            if (!moduleProgress[moduleId].videoWatched) {
                alert('Пожалуйста, сначала посмотрите видео этого модуля, чтобы разблокировать тест.');
                return;
            }
            
            // Проверяем, введены ли данные пользователя
            const savedUserData = localStorage.getItem('userData');
            if (savedUserData) {
                userData = JSON.parse(savedUserData);
                userId = localStorage.getItem('userId');
                startTest(moduleId);
            } else {
                document.getElementById('currentModule').value = moduleId;
                document.getElementById('userDataModal').style.display = 'flex';
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        async function startTest(moduleId) {
            closeModal('userDataModal');
            
            // Записываем время начала прохождения тестов, если это первый запуск
            if (!startTime && !localStorage.getItem('startTime')) {
                startTime = new Date();
                localStorage.setItem('startTime', startTime.toISOString());
                
                // Сохраняем пользователя в Supabase
                const { data, error } = await supabase
                    .from('users')
                    .insert([
                        { 
                            name: userData.name, 
                            email: userData.email, 
                            phone: userData.phone,
                            start_time: startTime.toISOString()
                        }
                    ])
                    .select();
                
                if (error) {
                    console.error('Ошибка при сохранении пользователя:', error);
                    alert('Произошла ошибка. Пожалуйста, попробуйте еще раз.');
                    return;
                }
                
                userId = data[0].id;
                localStorage.setItem('userId', userId);
            } else if (!startTime) {
                // Восстанавливаем время начала из localStorage
                startTime = new Date(localStorage.getItem('startTime'));
                userId = localStorage.getItem('userId');
            }
            
            // Загружаем соответствующий тест
            loadTest(moduleId);
            document.getElementById('testModal').style.display = 'flex';
            
            // Обновляем статус модуля
            moduleProgress[moduleId].started = true;
            updateModuleStatus(moduleId);
        }
        
        function loadTest(moduleId) {
            const testContent = document.getElementById('testContent');
            const test = tests[moduleId];
            
            let testHTML = `<h2>Тест к модулю ${moduleId}</h2>
                           <form id="testForm">`;
            
            test.forEach((q, index) => {
                testHTML += `<div class="question">
                    <div class="question-text">${index + 1}. ${q.question}</div>
                    <div class="options">`;
               
                // Добавляем уточнение для второго вопроса второго модуля
        if (moduleId === 2 && q.id === 2) {
            testHTML += `<div class="question-hint">Отметьте несколько вариантов ответа.</div>`;
        }
                
                if (q.type === 'radio') {
                    q.options.forEach((option, optIndex) => {
                        testHTML += `
                            <label>
                                <input type="radio" name="question${q.id}" value="${optIndex}" required>
                                ${option}
                            </label>`;
                    });
                } else if (q.type === 'checkbox') {
                    q.options.forEach((option, optIndex) => {
                        testHTML += `
                            <label>
                                <input type="checkbox" name="question${q.id}" value="${optIndex}">
                                ${option}
                            </label>`;
                    });
                } else if (q.type === 'text') {
                    testHTML += `
                        <textarea class="text-answer" name="question${q.id}" placeholder="Введите ваш ответ" required></textarea>`;
                }
                
                testHTML += `</div></div>`;
            });
            
            testHTML += `<button type="submit" class="btn">Завершить тест</button></form>`;
            
            testContent.innerHTML = testHTML;
            
            // Добавляем обработчик отправки формы теста
            document.getElementById('testForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitTest(moduleId);
            });
        }
        
        async function submitTest(moduleId) {
            const formData = new FormData(document.getElementById('testForm'));
            const answers = {};
            let score = 0;
            
            // Собираем ответы и проверяем правильность
            tests[moduleId].forEach(q => {
                if (q.type === 'radio') {
                    const answer = parseInt(formData.get(`question${q.id}`));
                    answers[q.id] = answer;
                    if (answer === q.correctAnswer) {
                        score++;
                    }
                } else if (q.type === 'checkbox') {
                    const selectedOptions = formData.getAll(`question${q.id}`).map(val => parseInt(val));
                    answers[q.id] = selectedOptions;
                    
                    // Проверяем, все ли правильные ответы отмечены и нет ли лишних
                    const isCorrect = arraysEqual(selectedOptions.sort(), q.correctAnswers.sort());
                    if (isCorrect) {
                        score++;
                    }
                } else if (q.type === 'text') {
                    isCorrect = true;
                    const answer = formData.get(`question${q.id}`);
                    answers[q.id] = answer;
                    // Для текстовых ответов оценка будет производиться вручную
                    score++; // Всегда правильный для текстовых вопросов
                }
            });
            
            // Сохраняем результаты в Supabase
            const { error } = await supabase
                .from('test_results')
                .insert([
                    { 
                        user_id: userId,
                        module: moduleId,
                        answers: answers,
                        score: score,
                        max_score: tests[moduleId].length,
                        completion_time: new Date().toISOString()
                    }
                ]);
            
            if (error) {
                console.error('Ошибка при сохранении результатов:', error);
                alert('Произошла ошибка при сохранении результатов. Пожалуйста, попробуйте еще раз.');
                return;
            }
            
             // Показываем результаты
    showTestResults(moduleId, answers, score);
        }
        function showTestResults(moduleId, userAnswers, score) {
    const testContent = document.getElementById('testContent');
    const test = tests[moduleId];
    
    let resultsHTML = `
        <h2>Результаты теста к модулю ${moduleId}</h2>
        <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: var(--border-radius);">
            <strong>Ваш результат: ${score} из ${test.length}</strong>
        </div>
    `;
    
    test.forEach((q, index) => {
        const userAnswer = userAnswers[q.id];
        let isCorrect = false;
        
        if (q.type === 'radio') {
            isCorrect = userAnswer === q.correctAnswer;
        } else if (q.type === 'checkbox') {
            isCorrect = arraysEqual(userAnswer.sort(), q.correctAnswers.sort());
        } else if (q.type === 'text') {
    isCorrect = true;
}
        
        resultsHTML += `
            <div class="question" style="border-left: 4px solid ${isCorrect ? 'var(--success-color)' : '#e74c3c'}; padding-left: 15px;">
                <div class="question-text">${index + 1}. ${q.question}</div>
                <div class="options" style="margin-top: 10px;">
        `;
        
        if (q.type === 'radio' || q.type === 'checkbox') {
            q.options.forEach((option, optIndex) => {
                const isUserChoice = q.type === 'radio' 
                    ? userAnswer === optIndex 
                    : userAnswer.includes(optIndex);
                const isCorrectOption = q.type === 'radio' 
                    ? optIndex === q.correctAnswer 
                    : q.correctAnswers.includes(optIndex);
                
                let optionStyle = '';
                if (isCorrectOption) {
                    optionStyle = 'background-color: #d4edda; border-left: 3px solid var(--success-color);';
                } else if (isUserChoice && !isCorrectOption) {
                    optionStyle = 'background-color: #f8d7da; border-left: 3px solid #e74c3c;';
                }
                
                resultsHTML += `
                    <label style="display: block; margin-bottom: 8px; padding: 8px; border-radius: 4px; ${optionStyle}">
                        <input type="${q.type}" ${isUserChoice ? 'checked' : ''} disabled style="margin-right: 10px;">
                        ${option}
                        ${isCorrectOption ? ' ✓' : ''}
                    </label>
                `;
            });
        } else if (q.type === 'text') {
             // Всегда считаем текстовые ответы правильными
            isCorrect = true;
            resultsHTML += `
                <div style="margin-bottom: 10px;">
            <strong>Ваш ответ:</strong>
            <div style="padding: 10px; background-color: #d4edda; border-radius: 4px; margin-top: 5px; border-left: 3px solid var(--success-color);">
                ${userAnswer || 'Ответ не предоставлен'}
            </div>
        </div>
        <div style="color: var(--success-color); font-weight: 500;">
            ✓ Ответ принят (развёрнутые ответы проверяются модератором)
        </div>
            `;
        }
        
        resultsHTML += `
                </div>
                
                ${q.type !== 'text' ? `
                <div style="margin-top: 10px; color: ${isCorrect ? 'var(--success-color)' : '#e74c3c'}; font-weight: 500;">
                    ${isCorrect ? '✓ Верно' : '✗ Неверно'}
                </div>
                ` : ''}
                
                
            </div>
        `;
    });
    
    resultsHTML += `
        <div style="margin-top: 30px; text-align: center;">
            <button class="btn" onclick="completeTest(${moduleId}, ${score})">Завершить</button>
        </div>
    `;
    
    testContent.innerHTML = resultsHTML;
    
    // Обновляем прогресс модуля
    moduleProgress[moduleId].completed = true;
    moduleProgress[moduleId].score = score;
    localStorage.setItem('moduleProgress', JSON.stringify(moduleProgress));
    updateModuleStatus(moduleId);
}
        function completeTest(moduleId, score) {
    
    // Закрываем модальное окно теста
    closeModal('testModal');
    
    // Проверяем, завершены ли все модули
    const allCompleted = Object.values(moduleProgress).every(module => module.completed);
    
    if (allCompleted) {
        // Обновляем время завершения для пользователя
        supabase
            .from('users')
            .update({ end_time: new Date().toISOString() })
            .eq('id', userId)
            .then(({ error }) => {
                if (error) {
                    console.error('Ошибка при обновлении времени завершения:', error);
                }
            });
        
        setTimeout(() => {
            document.getElementById('successModal').style.display = 'flex';
        }, 500);
    }
}
        
        function updateModuleStatus(moduleId) {
            const statusElement = document.getElementById(`status${moduleId}`);
            
            if (moduleProgress[moduleId].completed) {
                statusElement.textContent = `Результаты (${moduleProgress[moduleId].score}/${tests[moduleId].length})`;
                statusElement.className = 'module-status status-completed';
            } else if (moduleProgress[moduleId].started) {
                statusElement.textContent = 'В процессе';
                statusElement.className = 'module-status status-in-progress';
            } else {
                statusElement.textContent = 'Не начат';
                statusElement.className = 'module-status status-not-started';
            }
        }
        
        // Вспомогательная функция для сравнения массивов
        function arraysEqual(a, b) {
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) {
                if (a[i] !== b[i]) return false;
            }
            return true;
        }
        
        // Обработчик отправки формы пользовательских данных
        document.getElementById('userDataForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Сохраняем данные пользователя
            userData.name = document.getElementById('userName').value;
            userData.email = document.getElementById('userEmail').value;
            userData.phone = document.getElementById('userPhone').value;
            
            // Сохраняем данные в localStorage
            localStorage.setItem('userData', JSON.stringify(userData));
            
            const moduleId = document.getElementById('currentModule').value;
            startTest(parseInt(moduleId));
        });
        
        // Инициализация видеоплееров
        document.addEventListener('DOMContentLoaded', function() {
            // Загружаем сохраненные данные
            const savedUserData = localStorage.getItem('userData');
            const savedProgress = localStorage.getItem('moduleProgress');
            const savedUserId = localStorage.getItem('userId');
            const savedStartTime = localStorage.getItem('startTime');
            
            if (savedUserData) {
                userData = JSON.parse(savedUserData);
                document.getElementById('userName').value = userData.name;
                document.getElementById('userEmail').value = userData.email;
                document.getElementById('userPhone').value = userData.phone;
            }
            
            if (savedProgress) {
                moduleProgress = JSON.parse(savedProgress);
                
                // Обновляем статусы модулей
                for (let i = 1; i <= 3; i++) {
                    updateModuleStatus(i);
                }
            }
            
            if (savedUserId) {
                userId = savedUserId;
            }
            
            if (savedStartTime) {
                startTime = new Date(savedStartTime);
            }
            
            // Настройка обработчиков для видео
            const videos = document.querySelectorAll('video');
            videos.forEach((video, index) => {
                const moduleId = index + 1;
                
                // Проверяем, было ли видео уже просмотрено
                if (moduleProgress[moduleId].videoWatched) {
                    document.getElementById(`btn-module${moduleId}`).classList.remove('btn-disabled');
                }
                
                video.addEventListener('play', function() {
                    const moduleId = parseInt(this.id.replace('video', ''));
                    if (!moduleProgress[moduleId].started) {
                        moduleProgress[moduleId].started = true;
                        updateModuleStatus(moduleId);
                    }
                });
                
                video.addEventListener('timeupdate', function() {
                    const moduleId = parseInt(this.id.replace('video', ''));
                    // Считаем видео просмотренным, если пользователь посмотрел более 90%
                    if (this.currentTime > this.duration * 0.9 && !moduleProgress[moduleId].videoWatched) {
                        moduleProgress[moduleId].videoWatched = true;
                        document.getElementById(`btn-module${moduleId}`).classList.remove('btn-disabled');
                        localStorage.setItem('moduleProgress', JSON.stringify(moduleProgress));
                    }
                });
            });
        });
    </script>
</body>
</html>
